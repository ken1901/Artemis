# ----------------------------------------------------------------------------------------------------------------------
# Android End-To-End Tests Services
# ----------------------------------------------------------------------------------------------------------------------

services:
    artemis-android-e2e:
        # The linked android image built for testing. Usually put in some docker repository on each Play Store release.
        image: ${ANDROID_TEST_IMAGE_REPO}artemis-android/application:${ANDROID_APP_VERSION_TAG}
        depends_on:
            - artemis-app-setup
        environment:
            - USER_1_USERNAME=aa01aaa
            - USER_1_PASSWORD=test_user_1_password
            - USER_2_USERNAME=aa02aaa
            - USER_2_DISPLAY_NAME=Test User2
            - USER_3_USERNAME=aa03aaa
            - SERVER_URL=http://artemis-app:8080
            - DEFAULT_TIMEOUT=10000
            - ADMIN_USERNAME=artemis_admin
            - ADMIN_PASSWORD=artemis_admin
            - robolectric.logging.enabled=true
        command:
            - test
            - -Dskip.debugVariants=true
            - -Dskip.flavor.unrestricted=true
        networks:
            - artemis
        # Test results can be retrieved in test-outputs. Can be parsed by the Junit Parser
        volumes:
            - ../test-outputs/:/app/test-outputs/

    # We run mysql without any volumes. Each run should start from a clean state, however the Android tests can even run on a dirty database.
    mysql:
        extends:
            file: ./mysql-base.yml
            service: mysql
        environment:
            MYSQL_ALLOW_EMPTY_PASSWORD: true
            MYSQL_ROOT_PASSWORD: ""
            MYSQL_DATABASE: "Artemis"

    # Artemis server without any volumes -> Start with a clean state.
    artemis-app:
        extends:
            file: ./artemis-base.yml
            service: artemis-app
        depends_on:
            mysql:
                condition: service_healthy
        env_file:
            - ./artemis/config/androide2e.env
        extra_hosts:
            - "host.docker.internal:host-gateway"
        ports:
            - "8080:8080"
        expose:
            - "5005"
        networks:
            - artemis

    # For the Android E2E tests we need three users apart from the admin. They are created by this service using the provided script.
    artemis-app-setup:
        image: ellerbrock/alpine-bash-curl-ssl:latest
        depends_on:
            artemis-app:
                condition: service_healthy
        volumes:
            - ./artemis/create_test_users.sh:/create_test_users.sh
        entrypoint: /bin/bash -c "/bin/bash /create_test_users.sh artemis-app:8080"
        networks:
            - artemis

networks:
    artemis:
        driver: "bridge"
        name: artemis

